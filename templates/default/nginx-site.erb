server {

  server_name          <%= node.etherpadlite.proxy.hostname %> <%= node.etherpadlite.proxy.alias_hostnames.join(" ") %>;

  access_log           off;
  error_log            /var/log/etherpad-lite/error.log;

  <% if node.etherpadlite.proxy.ssl %>
  listen               [::]:443;
  ssl                  on;
  ssl_certificate      <%= @ssl_certfile %>;
  ssl_certificate_key  <%= @ssl_keyfile %>;
  ssl_session_timeout  5m;

  ssl_protocols        TLSv1 TLSv1.1 TLSv1.2; # not possible to do exclusive
  ssl_ciphers          'EDH+CAMELLIA:EDH+aRSA:EECDH+aRSA+AESGCM:EECDH+aRSA+SHA384:EECDH+RSA+SHA256:EECDH:+CAMELLIA256:+AES256:+CAMELLIA128:+AES128:+SSLv3:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!DSS:!RC4:!SEED:!ECDSA:CAMELLIA256-SHA:AES256-SHA:CAMELLIA128-SHA:AES128-SHA';

  ssl_prefer_server_ciphers   on;

  <% else %>
    listen             80;
  <% end %>

  location / {
    proxy_pass         http://localhost:9001/;
    proxy_set_header   Host $host;
    proxy_buffering    off;
  }
}

<% if node.etherpadlite.proxy.ssl %>
server {
  listen              [::]:80;
  server_name         <%= node.etherpadlite.proxy.hostname %> <%= node.etherpadlite.proxy.alias_hostnames.join(" ") %>;
  rewrite     ^(.*)   https://<%= node.etherpadlite.proxy.hostname %>$1 permanent;
}
<% end %>
